#!/usr/bin/env bash

function validate_terraform() {
  find . -type f -name "*.tf" -exec dirname {} \;|sort -u | while read m; do (terraform validate -check-variables=false "$m" && echo "âˆš $m") || exit 1 ; done
}

function wiremock() {
  if ! [ -f ~/wiremock.jar ]; then
    echo 'wiremock not found!'
    exit 1
  fi
  java -jar ~/wiremock.jar --port 9000 --proxy-all="$1" --record-mappings
}

function __wget() {
  : ${DEBUG:=0}
  local URL=$1
  local tag="Connection: close"
  local mark=0

  if [ -z "${URL}" ]; then
    printf "Usage: %s \"URL\" [e.g.: %s http://www.google.com/]" \
      "${FUNCNAME[0]}" "${FUNCNAME[0]}"
    return 1;
  fi

  read proto server path <<<$(echo ${URL//// })
  DOC=/${path// //}
  HOST=${server//:*}
  PORT=${server//*:}
  [[ x"${HOST}" == x"${PORT}" ]] && PORT=80
  [[ $DEBUG -eq 1 ]] && echo "HOST=$HOST"
  [[ $DEBUG -eq 1 ]] && echo "PORT=$PORT"
  [[ $DEBUG -eq 1 ]] && echo "DOC=$DOC"

  exec 3<>/dev/tcp/${HOST}/$PORT
  echo -en "GET ${DOC} HTTP/1.1\r\nHost: ${HOST}\r\n${tag}\r\n\r\n" >&3
  while read line; do
    [[ $mark -eq 1 ]] && echo $line
    if [[ "${line}" =~ ${tag} ]]; then
      mark=1
    fi
  done <&3
  exec 3>&-
}

function remove_duplicate_lines() {
  local source_file="$1"
  local dest_file="$2"
  aws '!visited[$0]++' "$source_file" "$dest_file"
}

function imeant() {
  # i might regret making this one day
  cmd="$(echo "$(history | tail -n2 | head -n1)" | sed "s/^.* 20.*_[A-Za-z]* *[A-Za-z0-9\-_]*/$1/")"
  echo " ... corrected to $cmd"
  eval $cmd
}
